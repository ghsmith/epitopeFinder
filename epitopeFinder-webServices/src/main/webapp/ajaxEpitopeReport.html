<!DOCTYPE html>


<html>

<head>

<meta name="viewport" content="width=device-width, initial-scale=0.86, maximum-scale=3.0, minimum-scale=0.86">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microplugin/0.0.3/microplugin.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sifter/0.5.3/sifter.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.default.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/selectize.js"></script>

<style>
           
body {
    font-family: monospace;
    font-size: medium;
}

table {
    border-collapse: collapse;
}

table th, table td {
    border: 1px solid gray;
}

table th.bead-not-in-current-panel {
    background: yellow;
}

table th.bead-not-in-ep-reg-panel {
    background: lightgray;
}

table th.antibody-present {
    background: green;
    color: white;
}

table th.rotate {
  /* Something you can count on */
  height: 200px;
  white-space: nowrap;
}

table th.rotate > div {
  transform: 
    /* Magic Numbers */
    translate(0px, 85px)
    /* 45 is really 360 - 45 */
    rotate(270deg);
  width: 20px;
}

table td.name {
    font-weight: bold;
}

table td.count {
    text-align: right;
    font-weight: bold;
}

.present {
    text-align: center;
    background-color: green;
    color: white;
}

.absent {
    text-align: center;
    background-color: red;
    color: white;
}

.unknown {
    text-align: center;
    background-color: yellow;
}

.selectize-input {
    border: 1px solid black;
}

</style>

<title>HLA Epitope Report</title>

</head>

<body>

    <div id="working" style="position: fixed; top: 0px; width: 150px; left: 50%; margin-left: -75px; text-align: center; background-color: red; color: white; font-weight: bold;">working...</div>

    <h1>HLA Epitope Report (<a href="https://github.com/ghsmith/epitopeFinder/blob/master/epitopeFinder-webServices/src/main/webapp/ajaxEpitopeReport.html">source code</a>)</h1>
    
    <p style="font-weight: bold; font-size: large;">This report uses epitopes defined in the <a href="http://www.epregistry.com.br/">HLA Epitope Registry</a>.</p>

    <p>
        Locus Group:
        <br/><select id="selectLocusGroup"></select>
    </p>

    <p>
        Recipient antibodies (multiple selections allowed, type to filter allele list):
        <br/><select id="selectAllelesAntibody" multiple="true" size="1"></select>
    </p>

    <p>
        Recipient HLA Type (multiple selections allowed, type to filter allele list):
        <br/><select id="selectAllelesRecipientType" multiple="true" size="1"></select>
    </p>

    <p>
        <input type="button" id="buttonGenerateReport" value="Generate Report" style="font-size: large; width: 100%"/>
    </p>

    <p style="border: 1px solid gray; padding: 10px;">
        <span class="present">+</span> = The single antigen bead (SAB) includes this epitope and the SAB is positive.<br/>
        <span class="absent">0</span> = The SAB includes this epitope, but the SAB is negative (if the antibody was reactive with this epitope, the SAB would have been positive).<br/>
            <span class="unknown">?</span> = The SAB includes this epitope, but this SAB is not part of the One Lambda panel (so the antibody may or may not be reactive with this epitope).<br/>
    </p>
    
    <div id="divReport">
        <div style="text-align: center; font-size: large;">Press <i>Generate Report</i> when you are ready to view the report.</div>
    </div>
    
    <p><br/>Copyright &copy; 2018, Geoffrey H. Smith, MD

</body>

</html>

<script>

var sessionId;
var locusGroups = [ {lgName: "ABC"}, {lgName: "DRB"}, {lgName: "DQ"}, {lgName: "DP"} ];
var alleles = [];
var epitopes = [];

function getSessionId() {
    $("#working").show();
    return $.ajax({
        url: "/epitopeFinder/resources/session",
        dataType: "text"
    }).then(function(response) {
        sessionId = response;
    });
}

function resetSession() {
    $("#working").show();
    return $.ajax({
        url: "/epitopeFinder/resources/session/reset",
        dataType: "json",
        type: "PUT",
        contentType: "application/json"
    });
}

function computeCompat() {
    $("#working").show();
    return $.ajax({
        url: "/epitopeFinder/resources/session/computeCompat",
        dataType: "json",
        type: "PUT",
        contentType: "application/json"
    });
}

function getAlleles() {
    $("#working").show();
    return $.ajax({
        url: "/epitopeFinder/resources/alleles?locusGroup=" + $("#selectLocusGroup").val(),
        dataType: "json"
    }).then(function(response) {
        alleles = response;
    });
}

function putAllele(allele) {
    $("#working").show();
    return $.ajax({
        url: "/epitopeFinder/resources/alleles/" + allele.alleleName,
        dataType: "json",
        type: "PUT",
        contentType: "application/json",
        data: JSON.stringify(allele)
    });
}

function getEpitopes() {
    $("#working").show();
    return $.ajax({
        url: "/epitopeFinder/resources/epRegEpitopes/" + $("#selectLocusGroup").val() + "?panelAllelesOnly=true",
        dataType: "json"
    }).then(function(response) {
        epitopes = response;
    });
}

// Document ready! Let's go...
$(document).ready(function() {

    $("#working").show();
    $(document).tooltip();
    getSessionId()
    .then(function() {
         $('#selectLocusGroup').selectize({ options: locusGroups, valueField: "lgName", labelField: "lgName", items: ["ABC"] });
    })
    .then(getAlleles)
    .then(function() {
        $('#selectAllelesAntibody').selectize({ maxItems: 10, maxOptions: 500, placeholder: "no recipient antibodies selected", plugins: ['remove_button'], options: alleles, valueField: "epRegAlleleName", labelField: "epRegAlleleName", searchField: "epRegAlleleName", sortField: "sequenceNumber", items: alleles.filter(function(allele) { return allele.recipientAntibodyForCompat; }).map(function(allele) { return allele.epRegAlleleName; }) });
        $('#selectAllelesRecipientType').selectize({ maxItems: 10, maxOptions: 500, placeholder: "no recipient HLA type selected", plugins: ['remove_button'], options: alleles, valueField: "epRegAlleleName", labelField: "epRegAlleleName", searchField: "epRegAlleleName", sortField: "sequenceNumber", items: alleles.filter(function(allele) { return allele.recipientTypeForCompat; }).map(function(allele) { return allele.epRegAlleleName; }) });
    })
    .done(function() {
        $("#working").hide();
    });

    $("#selectLocusGroup").change(function() {
        $("#working").show();
        getAlleles()
        .then(function() {
            {
                var s = $("#selectAllelesAntibody")[0].selectize;
                s.clear();
                s.clearOptions();
                s.load(function(callback) { callback(alleles); });
                s.setValue(alleles.filter(function(allele) { return allele.recipientAntibodyForCompat; }).map(function(allele) { return allele.epRegAlleleName; }));
            }
            {
                var s = $("#selectAllelesRecipientType")[0].selectize;
                s.clear();
                s.clearOptions();
                s.load(function(callback) { callback(alleles); });
                s.setValue(alleles.filter(function(allele) { return allele.recipientTypeForCompat; }).map(function(allele) { return allele.epRegAlleleName; }));
            }
        })              
        .done(function() {
            $("#working").hide();
        });
    });

    $("#buttonGenerateReport").click(function() {
        $("#working").show();
        var setAllelesToPut = new Set();
        $.each(alleles.filter(function(allele) { return allele.recipientAntibodyForCompat || allele.recipientTypeForCompat; }), function(index, allele) {
            allele.recipientAntibodyForCompat = false;
            allele.recipientTypeForCompat = false;
            setAllelesToPut.add(allele);
        });
        $.each($("#selectAllelesAntibody").val(), function(index, epRegAlleleName) {
            var allele = alleles.find(function(allele) { return allele.epRegAlleleName == epRegAlleleName; });
            allele.recipientAntibodyForCompat = true;
            setAllelesToPut.add(allele);
        });
        $.each($("#selectAllelesRecipientType").val(), function(index, epRegAlleleName) {
            var allele = alleles.find(function(allele) { return allele.epRegAlleleName == epRegAlleleName; });
            allele.recipientTypeForCompat = true;
            setAllelesToPut.add(allele);
        });
        var dfrs = [];
        $.each(Array.from(setAllelesToPut), function(index, allele) {
            delete allele.$order;
            dfrs.push(putAllele(allele));
        });
        $.when.apply(null, dfrs).then(computeCompat)
        .then(getEpitopes)
        .done(function() {

            var htmlReport = [];
            htmlReport.push("<table id='tableReport'>");
            htmlReport.push("<tr><th>epitope</th><th>&nbsp;+&nbsp;</th><th>&nbsp;0&nbsp;</th><th>&nbsp;?&nbsp;</th>")
            $.each(alleles.filter(function(allele) { return allele.inCurrentSabPanel || allele.inEpRegSabPanel; }), function(index, allele) {
                htmlReport.push("<th class='rotate" + (!allele.inCurrentSabPanel ? " bead-not-in-current-panel " : " ") + (allele.inCurrentSabPanel && !allele.inEpRegSabPanel ? " bead-not-in-ep-reg-panel " : " ") + (allele.recipientAntibodyForCompat ? " antibody-present " : "") + "'><div>" + allele.epRegAlleleName + "</div></th>");
            });
            htmlReport.push("</tr>");
            $.each(epitopes.filter(function(epitope) { return epitope.compatSabPanelCountPresent > 0; }), function(index, epitope) {
                htmlReport.push("<tr>");
                htmlReport.push("<td class='name'>" + epitope.epitopeName + "</td>");
                htmlReport.push("<td class='count'>" + epitope.compatSabPanelCountPresent + "</td>");
                htmlReport.push("<td class='count'>" + epitope.compatSabPanelCountAbsent + "</td>");
                htmlReport.push("<td class='count'>" + epitope.compatSabPanelCountUnknown + "</td>");
                $.each(alleles.filter(function(allele) { return allele.inCurrentSabPanel || allele.inEpRegSabPanel; }), function(index, allele) {
                    var compatStatus = (epitope.alleleMap[allele.epRegAlleleName] ? epitope.alleleMap[allele.epRegAlleleName].compatStatus : "");
                    htmlReport.push("<td class='" + (compatStatus == "+" ? "present" : "") + (compatStatus == "0" ? "absent" : "") + (compatStatus == "?" ? "unknown" : "") + "' title='" + epitope.epitopeName + " / " + allele.epRegAlleleName + "'>" + compatStatus + "</td>");
                });
                htmlReport.push("</tr>");
            });
            htmlReport.push("</table>");
            $("#divReport").html(htmlReport.join(""));
            
            $("#working").hide();
        });
    });
        
});

</script>
